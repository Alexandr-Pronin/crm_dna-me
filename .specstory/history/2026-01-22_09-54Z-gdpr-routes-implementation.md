<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 4d4bbf38-6bcd-4bcb-8a55-4ac4e696050e (2026-01-22 09:54Z) -->

# GDPR routes implementation (2026-01-22 09:54Z)

_**User (2026-01-22 09:18Z)**_

Implement the following to-dos from the plan (the plan is attached for your reference). Do NOT edit the plan file itself.

You have been assigned the following 1 to-do(s) with IDs: gdpr-routes

1. [gdpr-routes] Erstelle src/api/routes/gdpr.ts fur GDPR Export/Delete

These to-dos have already been created. Do not create them again. Mark them as in_progress as you work, starting with the first one. Don't stop until you have completed all the assigned to-dos.

---

_**Agent (model claude-4.5-opus-high-thinking, mode Agent)**_

<think><details><summary>Thought Process</summary>
Der Benutzer möchte, dass ich die GDPR Routes implementiere. Laut dem Plan soll ich:

1. `src/api/routes/gdpr.ts` erstellen mit:
   - GET `/api/v1/gdpr/export/:leadId` - Export all lead data as JSON
   - DELETE `/api/v1/gdpr/delete/:leadId` - Delete lead with cascade + anonymize

Ich sollte zuerst die Master-Prompt Dokumentation und den bestehenden Code untersuchen, um die Konventionen und Struktur zu verstehen.

Lassen Sie mich:
1. Die Todo als in_progress markieren
2. Die existierenden Route-Dateien und Services untersuchen, um die Struktur zu verstehen
3. Die GDPR Routes implementieren</details></think>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [-] Erstelle src/api/routes/gdpr.ts für GDPR Export/Delete

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: e:\dname\crm_dna-me\docs\DNA_ME_CRM_CURSOR_MASTER_PROMPT_PART1.md</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: e:\dname\crm_dna-me\docs\DNA_ME_CRM_CURSOR_MASTER_PROMPT_PART2.md</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_dir** • Listed directory, 0 results</summary>
        
No results found
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Jetzt habe ich ein klares Bild der Projektstruktur und was benötigt wird. Laut dem Master-Prompt soll ich:

1. `src/api/routes/gdpr.ts` erstellen mit:
   - GET `/api/v1/gdpr/export/:leadId` - Export all lead data as JSON
   - DELETE `/api/v1/gdpr/delete/:leadId` - Delete lead with cascade + anonymize

Ich werde mir zunächst eine bestehende Route-Datei ansehen, um die Konventionen zu verstehen.</details></think>

---

Ich werde zunächst eine bestehende Route-Datei untersuchen, um die Konventionen zu verstehen, sowie die Types und die DB-Verbindung.

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: e:\dname\crm_dna-me\src\api\routes\leads.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: e:\dname\crm_dna-me\src\types\index.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: e:\dname\crm_dna-me\src\db\index.ts</summary>

</details>
</tool-use>

---

Could not find file 'e:\dname\crm_dna-me\src\api\index.ts' in the workspace.

---

<think><details><summary>Thought Process</summary>
Lass mich nun die src/api Ordnerstruktur und die Errors sowie Middleware betrachten, um die vollständigen Konventionen zu verstehen.</details></think>

---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_dir** • Listed directory, 0 results</summary>
        
No results found
</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: e:\dname\crm_dna-me\src\errors\index.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: e:\dname\crm_dna-me\src\api\middleware\apiKey.ts</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Jetzt habe ich ein gutes Bild der Projektstruktur und Konventionen. Ich muss jetzt die GDPR Routes erstellen. Laut dem Plan sollen die Routes folgende Funktionalität haben:

1. GET `/api/v1/gdpr/export/:leadId` - Export all lead data as JSON
2. DELETE `/api/v1/gdpr/delete/:leadId` - Delete lead with cascade + anonymize

Die Route-Datei soll dem Stil der anderen Route-Dateien folgen. Ich brauche noch die Server-Datei, um zu sehen, wie die Routes registriert werden.</details></think>

---

Ich schaue mir noch an, wie die Routes registriert werden.

---

<tool-use data-tool-type="generic" data-tool-name="glob_file_search">
<details>
<summary>Tool use: **glob_file_search** • Searched codebase "**/server.ts" • **0** result in **1** directory</summary>

Directory: **e:\dname\crm_dna-me\src** (0 file)

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: e:\dname\crm_dna-me\src\index.ts</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Jetzt habe ich alle Informationen, die ich brauche. Ich werde die GDPR Routes erstellen:

1. `GET /api/v1/gdpr/export/:leadId` - Export all lead data as JSON
2. `DELETE /api/v1/gdpr/delete/:leadId` - Delete lead with cascade + anonymize

Ich werde folgendes tun:
1. Die GDPR Routes Datei erstellen (`src/api/routes/gdpr.ts`)
2. Die Route in `src/index.ts` registrieren

Die GDPR Export sollte alle Daten eines Leads zurückgeben:
- Lead-Grunddaten
- Organisation
- Events
- Score-History
- Intent-Signals
- Deals
- Tasks

Die GDPR Delete sollte:
- Alle verbundenen Daten löschen (CASCADE durch DB oder manuell)
- Lead-Daten anonymisieren (Email, Name, etc.)
- Eine Audit-Trail hinterlassen

Ich werde die Route nach den Konventionen der anderen Routes erstellen.</details></think>

---

Jetzt habe ich alle nötigen Informationen. Ich werde die GDPR Routes erstellen.

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **write** • Edit file: e:\dname\crm_dna-me\src\api\routes\gdpr.ts</summary>

**Chunk 1**
Lines added: 402, lines removed: 1

```diff
@@ -1,1 +1,402 @@
- 
+ // =============================================================================
+ // src/api/routes/gdpr.ts
+ // GDPR Compliance API Routes (Export &amp; Delete)
+ // =============================================================================
+ 
+ import type { FastifyInstance } from 'fastify';
+ import { validateApiKey } from '../middleware/apiKey.js';
+ import { db } from '../../db/index.js';
+ import { NotFoundError, ValidationError } from '../../errors/index.js';
+ import type { Lead, Organization, MarketingEvent, ScoreHistory, IntentSignal, Deal, Task } from '../../types/index.js';
+ import { z } from 'zod';
+ 
+ // =============================================================================
+ // Types
+ // =============================================================================
+ 
+ interface LeadIdParams {
+   leadId: string;
+ }
+ 
+ interface GdprExportResponse {
+   lead: Lead;
+   organization: Organization | null;
+   events: MarketingEvent[];
+   score_history: ScoreHistory[];
+   intent_signals: IntentSignal[];
+   deals: Deal[];
+   tasks: Task[];
+   export_date: string;
+   export_format_version: string;
+ }
+ 
+ interface GdprDeleteResponse {
+   success: boolean;
+   message: string;
+   lead_id: string;
+   anonymized_email: string;
+   deleted_records: {
+     events: number;
+     score_history: number;
+     intent_signals: number;
+     deals: number;
+     tasks: number;
+   };
+   deleted_at: string;
+ }
+ 
+ // =============================================================================
+ // Validation Schema
+ // =============================================================================
+ 
+ const leadIdParamSchema = z.object({
+   leadId: z.string().uuid('Lead ID must be a valid UUID')
+ });
+ 
+ // =============================================================================
+ // Helper Functions
+ // =============================================================================
+ 
+ /**
+  * Generate anonymized email from lead ID
+  */
+ function generateAnonymizedEmail(leadId: string): string {
+   const hash = leadId.replace(/-/g, '').substring(0, 12);
+   return &#96;deleted_${hash}@anonymized.local&#96;;
+ }
+ 
+ /**
+  * Generate anonymized value for text fields
+  */
+ function generateAnonymizedText(prefix: string): string {
+   return &#96;[GDPR_DELETED_${prefix.toUpperCase()}]&#96;;
+ }
+ 
+ // =============================================================================
+ // Route Registration
+ // =============================================================================
+ 
+ export async function gdprRoutes(fastify: FastifyInstance): Promise&lt;void&gt; {
+   // ===========================================================================
+   // GET /api/v1/gdpr/export/:leadId
+   // ===========================================================================
+   /**
+    * Export all data associated with a lead for GDPR compliance.
+    * Returns a comprehensive JSON document containing all lead-related data.
+    */
+   fastify.get&lt;{
+     Params: LeadIdParams;
+     Reply: GdprExportResponse;
+   }&gt;(
+     '/gdpr/export/:leadId',
+     {
+       preHandler: validateApiKey,
+       schema: {
+         description: 'Export all lead data for GDPR compliance',
+         tags: ['GDPR'],
+         params: {
+           type: 'object',
+           required: ['leadId'],
+           properties: {
+             leadId: { type: 'string', format: 'uuid', description: 'Lead ID to export data for' }
+           }
+         },
+         response: {
+           200: {
+             type: 'object',
+             description: 'Complete export of all lead data',
+             properties: {
+               lead: { type: 'object' },
+               organization: { type: ['object', 'null'] },
+               events: { type: 'array', items: { type: 'object' } },
+               score_history: { type: 'array', items: { type: 'object' } },
+               intent_signals: { type: 'array', items: { type: 'object' } },
+               deals: { type: 'array', items: { type: 'object' } },
+               tasks: { type: 'array', items: { type: 'object' } },
+               export_date: { type: 'string', format: 'date-time' },
+               export_format_version: { type: 'string' }
+             }
+           },
+           404: {
+             type: 'object',
+             properties: {
+               error: {
+                 type: 'object',
+                 properties: {
+                   code: { type: 'string' },
+                   message: { type: 'string' }
+                 }
+               }
+             }
+           }
+         }
+       }
+     },
+     async (request, reply) =&gt; {
+       const parseResult = leadIdParamSchema.safeParse(request.params);
+ 
+       if (!parseResult.success) {
+         throw new ValidationError('Invalid lead ID', {
+           validationErrors: parseResult.error.errors
+         });
+       }
+ 
+       const { leadId } = parseResult.data;
+ 
+       // Fetch lead
+       const lead = await db.queryOne&lt;Lead&gt;(
+         'SELECT * FROM leads WHERE id = $1',
+         [leadId]
+       );
+ 
+       if (!lead) {
+         throw new NotFoundError('Lead', leadId);
+       }
+ 
+       // Fetch all related data in parallel for better performance
+       const [organization, events, scoreHistory, intentSignals, deals, tasks] = await Promise.all([
+         // Organization (if linked)
+         lead.organization_id
+           ? db.queryOne&lt;Organization&gt;(
+               'SELECT * FROM organizations WHERE id = $1',
+               [lead.organization_id]
+             )
+           : Promise.resolve(null),
+ 
+         // Events
+         db.query&lt;MarketingEvent&gt;(
+           'SELECT * FROM events WHERE lead_id = $1 ORDER BY occurred_at DESC',
+           [leadId]
+         ),
+ 
+         // Score history
+         db.query&lt;ScoreHistory&gt;(
+           'SELECT * FROM score_history WHERE lead_id = $1 ORDER BY created_at DESC',
+           [leadId]
+         ),
+ 
+         // Intent signals
+         db.query&lt;IntentSignal&gt;(
+           'SELECT * FROM intent_signals WHERE lead_id = $1 ORDER BY detected_at DESC',
+           [leadId]
+         ),
+ 
+         // Deals
+         db.query&lt;Deal&gt;(
+           'SELECT * FROM deals WHERE lead_id = $1 ORDER BY created_at DESC',
+           [leadId]
+         ),
+ 
+         // Tasks
+         db.query&lt;Task&gt;(
+           'SELECT * FROM tasks WHERE lead_id = $1 ORDER BY created_at DESC',
+           [leadId]
+         )
+       ]);
+ 
+       request.log.info({
+         leadId,
+         eventCount: events.length,
+         scoreHistoryCount: scoreHistory.length,
+         intentSignalsCount: intentSignals.length,
+         dealsCount: deals.length,
+         tasksCount: tasks.length
+       }, 'GDPR data export completed');
+ 
+       return {
+         lead,
+         organization,
+         events,
+         score_history: scoreHistory,
+         intent_signals: intentSignals,
+         deals,
+         tasks,
+         export_date: new Date().toISOString(),
+         export_format_version: '1.0'
+       };
+     }
+   );
+ 
+   // ===========================================================================
+   // DELETE /api/v1/gdpr/delete/:leadId
+   // ===========================================================================
+   /**
+    * Delete a lead and all associated data for GDPR compliance.
+    * This performs a cascading delete and anonymizes the lead record
+    * to maintain referential integrity while removing personal data.
+    */
+   fastify.delete&lt;{
+     Params: LeadIdParams;
+     Reply: GdprDeleteResponse;
+   }&gt;(
+     '/gdpr/delete/:leadId',
+     {
+       preHandler: validateApiKey,
+       schema: {
+         description: 'Delete lead and anonymize data for GDPR compliance',
+         tags: ['GDPR'],
+         params: {
+           type: 'object',
+           required: ['leadId'],
+           properties: {
+             leadId: { type: 'string', format: 'uuid', description: 'Lead ID to delete' }
+           }
+         },
+         response: {
+           200: {
+             type: 'object',
+             description: 'Deletion confirmation with statistics',
+             properties: {
+               success: { type: 'boolean' },
+               message: { type: 'string' },
+               lead_id: { type: 'string' },
+               anonymized_email: { type: 'string' },
+               deleted_records: {
+                 type: 'object',
+                 properties: {
+                   events: { type: 'integer' },
+                   score_history: { type: 'integer' },
+                   intent_signals: { type: 'integer' },
+                   deals: { type: 'integer' },
+                   tasks: { type: 'integer' }
+                 }
+               },
+               deleted_at: { type: 'string', format: 'date-time' }
+             }
+           },
+           404: {
+             type: 'object',
+             properties: {
+               error: {
+                 type: 'object',
+                 properties: {
+                   code: { type: 'string' },
+                   message: { type: 'string' }
+                 }
+               }
+             }
+           }
+         }
+       }
+     },
+     async (request, reply) =&gt; {
+       const parseResult = leadIdParamSchema.safeParse(request.params);
+ 
+       if (!parseResult.success) {
+         throw new ValidationError('Invalid lead ID', {
+           validationErrors: parseResult.error.errors
+         });
+       }
+ 
+       const { leadId } = parseResult.data;
+ 
+       // Check if lead exists
+       const lead = await db.queryOne&lt;Lead&gt;(
+         'SELECT * FROM leads WHERE id = $1',
+         [leadId]
+       );
+ 
+       if (!lead) {
+         throw new NotFoundError('Lead', leadId);
+       }
+ 
+       const anonymizedEmail = generateAnonymizedEmail(leadId);
+       const deletionTime = new Date();
+       const deletedRecords = {
+         events: 0,
+         score_history: 0,
+         intent_signals: 0,
+         deals: 0,
+         tasks: 0
+       };
+ 
+       // Execute deletion within a transaction
+       await db.instance.transaction(async (client) =&gt; {
+         // 1. Delete events (they have ON DELETE CASCADE, but we count them)
+         const eventsResult = await client.query(
+           'DELETE FROM events WHERE lead_id = $1',
+           [leadId]
+         );
+         deletedRecords.events = eventsResult.rowCount ?? 0;
+ 
+         // 2. Delete score history (ON DELETE CASCADE)
+         const scoreResult = await client.query(
+           'DELETE FROM score_history WHERE lead_id = $1',
+           [leadId]
+         );
+         deletedRecords.score_history = scoreResult.rowCount ?? 0;
+ 
+         // 3. Delete intent signals (ON DELETE CASCADE)
+         const intentResult = await client.query(
+           'DELETE FROM intent_signals WHERE lead_id = $1',
+           [leadId]
+         );
+         deletedRecords.intent_signals = intentResult.rowCount ?? 0;
+ 
+         // 4. Delete tasks associated with the lead
+         const tasksResult = await client.query(
+           'DELETE FROM tasks WHERE lead_id = $1',
+           [leadId]
+         );
+         deletedRecords.tasks = tasksResult.rowCount ?? 0;
+ 
+         // 5. Delete deals associated with the lead
+         const dealsResult = await client.query(
+           'DELETE FROM deals WHERE lead_id = $1',
+           [leadId]
+         );
+         deletedRecords.deals = dealsResult.rowCount ?? 0;
+ 
+         // 6. Anonymize the lead record instead of deleting it
+         // This preserves referential integrity and audit trail
+         await client.query(
+           &#96;UPDATE leads SET
+             email = $2,
+             first_name = $3,
+             last_name = $4,
+             phone = NULL,
+             job_title = NULL,
+             linkedin_url = NULL,
+             portal_id = NULL,
+             waalaxy_id = NULL,
+             lemlist_id = NULL,
+             consent_date = NULL,
+             consent_source = NULL,
+             gdpr_delete_requested = $5,
+             status = 'churned',
+             lifecycle_stage = 'lead',
+             routing_status = 'unrouted',
+             pipeline_id = NULL,
+             updated_at = $5
+           WHERE id = $1&#96;,
+           [
+             leadId,
+             anonymizedEmail,
+             generateAnonymizedText('first_name'),
+             generateAnonymizedText('last_name'),
+             deletionTime
+           ]
+         );
+       });
+ 
+       request.log.info({
+         leadId,
+         originalEmail: lead.email,
+         anonymizedEmail,
+         deletedRecords
+       }, 'GDPR deletion completed');
+ 
+       return {
+         success: true,
+         message: 'Lead data has been deleted and anonymized in compliance with GDPR',
+         lead_id: leadId,
+         anonymized_email: anonymizedEmail,
+         deleted_records: deletedRecords,
+         deleted_at: deletionTime.toISOString()
+       };
+     }
+   );
+ }
+ 
+ export default gdprRoutes;
+ 
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Jetzt muss ich die GDPR Routes in der `src/index.ts` registrieren. Ich werde den Import und die Registrierung hinzufügen.</details></think>

---

Jetzt registriere ich die GDPR Routes in der Hauptdatei.

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: e:\dname\crm_dna-me\src\index.ts</summary>

**Chunk 1**
Lines added: 1, lines removed: undefined

```diff
@@ -20,4 +20,5 @@
  import { tasksRoutes } from './api/routes/tasks.js';
  import { automationRoutes } from './api/routes/automation.js';
+ import { gdprRoutes } from './api/routes/gdpr.js';
  import type { HealthCheckResponse } from './types/index.js';
  
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Jetzt muss ich auch die Route registrieren. Ich werde sie zu den anderen Routes hinzufügen.</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: e:\dname\crm_dna-me\src\index.ts</summary>

**Chunk 1**
Lines added: 1, lines removed: undefined

```diff
@@ -141,4 +141,5 @@
  await fastify.register(tasksRoutes, { prefix: '/api/v1' });
  await fastify.register(automationRoutes, { prefix: '/api/v1' });
+ await fastify.register(gdprRoutes, { prefix: '/api/v1' });
  
  // =============================================================================
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Jetzt überprüfe ich ob es Linter-Fehler gibt in den von mir bearbeiteten Dateien.</details></think>

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 2 files</summary>
      
Lint paths:

- `e:\dname\crm_dna-me\src\api\routes\gdpr.ts`
- `e:\dname\crm_dna-me\src\index.ts`

Lint results


**No lint errors found**
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Sehr gut, keine Lint-Fehler. Jetzt sollte ich die Todo als abgeschlossen markieren und eine kurze Zusammenfassung geben.</details></think>

---

Ausgezeichnet! Die GDPR Routes wurden erfolgreich erstellt.

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Erstelle src/api/routes/gdpr.ts für GDPR Export/Delete

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Ich habe die Aufgabe abgeschlossen. Lassen Sie mich nun eine Zusammenfassung geben.</details></think>

---

Ich habe die GDPR Routes erfolgreich implementiert. Hier ist eine Zusammenfassung der Änderungen:

## Erstellte Datei: `src/api/routes/gdpr.ts`

Die Datei enthält zwei GDPR-konforme Endpoints:

### 1. GET `/api/v1/gdpr/export/:leadId`
Exportiert alle Lead-Daten als JSON:
- Lead-Grunddaten
- Verknüpfte Organisation
- Marketing-Events
- Score-Historie
- Intent-Signale
- Deals
- Tasks
- Export-Metadaten (Datum, Format-Version)

### 2. DELETE `/api/v1/gdpr/delete/:leadId`
Löscht Lead-Daten GDPR-konform:
- Löscht alle verknüpften Datensätze (Events, Scores, Intents, Tasks, Deals)
- **Anonymisiert** den Lead-Record statt ihn zu löschen (für Audit-Trail)
- Setzt Email auf `deleted_[hash]@anonymized.local`
- Setzt persönliche Felder auf `[GDPR_DELETED_...]`
- Gibt Statistiken über gelöschte Records zurück
- Verwendet eine Transaktion für Datenkonsistenz

## Geänderte Datei: `src/index.ts`

Die GDPR Routes wurden registriert:

```typescript
import { gdprRoutes } from './api/routes/gdpr.js';
// ...
await fastify.register(gdprRoutes, { prefix: '/api/v1' });
```

Die Implementation folgt den bestehenden Konventionen des Projekts (Fastify-Schema-Validierung, Zod für Parameter, Error-Handling mit benutzerdefinierten Error-Klassen, API-Key-Authentifizierung).

---

