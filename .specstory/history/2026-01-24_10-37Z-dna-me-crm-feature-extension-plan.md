<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 6aa79ccc-ec4e-436a-b545-cc8154e31605 (2026-01-24 10:37Z) -->

# DNA ME CRM feature extension plan (2026-01-24 10:37Z)

_**User (2026-01-24 09:54Z)**_

DNA ME CRM - Feature Erweiterung
Architektur-Ubersicht
flowchart TB
    subgraph Frontend [Frontend - React]
        KB[KanbanBoard]
        KC[KanbanColumn]
        STM[StageTriggersModal]
        PMC[PipelineManagement]
        ESB[EmailSequenceBuilder]
    end

    subgraph Backend [Backend - Fastify]
        TR[TriggerRoutes]
        PR[PipelineRoutes]
        ER[EmailSequenceRoutes]
        TS[TriggerService]
        ES[EmailService]
    end

    subgraph Integrations [Integrationen]
        MOCO[MocoService]
        CITURO[CituroService]
        SLACK[SlackService]
        SMTP[SMTPService]
    end

    subgraph DB [PostgreSQL]
        PST[pipeline_stages]
        AR[automation_rules]
        SEQ[email_sequences]
        ENR[sequence_enrollments]
    end

    KC --> STM
    STM --> TR
    TR --> TS
    TS --> MOCO
    TS --> CITURO
    TS --> SLACK
    TS --> AR
    ESB --> ER
    ER --> ES
    ES --> SMTP
    ES --> SEQ
    ES --> ENR
Phase 1: Stage-Trigger System (Prioritat 1)
1.1 Backend - Cituro Integration
Neue Datei: src/integrations/cituro.ts

Booking-Link generieren
Meeting-Einladungen versenden
Verfugbarkeit prufen
1.2 Backend - Trigger Service erweitern
Datei: src/services/triggerService.ts (neu)

Aktionen:

send_email - E-Mail uber SMTP senden
create_moco_project - Projekt in Moco erstellen
create_moco_customer - Kunde in Moco erstellen
create_moco_offer - Angebot in Moco erstellen
send_cituro_booking - Buchungslink per E-Mail
send_slack_message - Nachricht in Slack-Channel
1.3 Backend - API Route fur Trigger
Datei: src/api/routes/triggers.ts (neu)

Endpoints:

POST /api/v1/triggers/execute - Trigger manuell ausfuhren
GET /api/v1/stages/:id/triggers - Verfugbare Trigger fur Stage
POST /api/v1/stages/:id/triggers - Trigger-Konfiguration speichern
1.4 Frontend - Stage Trigger Modal
Neue Komponente: frontend/src/components/Kanban/StageTriggersModal.jsx

Zahnrad-Icon in KanbanColumn Header
Modal mit verfugbaren Aktionen
Deal-Auswahl fur Trigger-Ausfuhrung
1.5 Frontend - KanbanColumn erweitern
Datei: frontend/src/components/Kanban/KanbanColumn.jsx

Settings-Icon (Zahnrad) im Header hinzufugen
onClick offnet StageTriggersModal
Phase 2: Deal-Lead Zuordnung
2.1 Frontend - Lead Dropdown im Deal
Datei: frontend/src/components/Kanban/DealPreviewModal.jsx

Autocomplete-Dropdown fur Lead-Auswahl
API-Call zum Andern des lead_id
Validierung: Deal kann nicht ohne Lead existieren
2.2 Backend - Deal Lead Update
Datei: src/api/routes/deals.ts

PATCH /api/v1/deals/:id/lead - Lead andern
Validierung dass neuer Lead existiert
Phase 3: Adaptive Pipelines & Stages
3.1 Datenbank Migration
Neue Migration: migrations/TIMESTAMP_pipeline_stage_management.sql

ALTER TABLE pipeline_stages ADD COLUMN color VARCHAR(7) DEFAULT '#6C5CE7';
ALTER TABLE pipeline_stages ADD COLUMN icon VARCHAR(50);
ALTER TABLE pipeline_stages ADD COLUMN is_won BOOLEAN DEFAULT FALSE;
ALTER TABLE pipeline_stages ADD COLUMN is_lost BOOLEAN DEFAULT FALSE;
3.2 Backend - Pipeline CRUD
Datei: src/api/routes/pipelines.ts erweitern:

POST /api/v1/pipelines - Pipeline erstellen
PATCH /api/v1/pipelines/:id - Pipeline bearbeiten
DELETE /api/v1/pipelines/:id - Pipeline loschen
POST /api/v1/pipelines/:id/stages - Stage hinzufugen
PATCH /api/v1/stages/:id - Stage bearbeiten
DELETE /api/v1/stages/:id - Stage loschen
POST /api/v1/pipelines/:id/stages/reorder - Stages neu ordnen
3.3 Frontend - Pipeline Management
Neue Seite: frontend/src/pages/Pipelines/PipelineSettings.jsx

Drag & Drop fur Stage-Reihenfolge
Inline-Bearbeitung von Stage-Namen
Farb-Picker fur Stages
Neue Pipeline erstellen Dialog
Phase 4: E-Mail Marketing Sequenzen
4.1 Datenbank Migration
Neue Migration: migrations/TIMESTAMP_email_sequences.sql

CREATE TABLE email_sequences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    trigger_event VARCHAR(50),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE email_sequence_steps (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    sequence_id UUID REFERENCES email_sequences(id) ON DELETE CASCADE,
    position INTEGER NOT NULL,
    delay_days INTEGER NOT NULL DEFAULT 0,
    delay_hours INTEGER DEFAULT 0,
    subject VARCHAR(255) NOT NULL,
    body_html TEXT NOT NULL,
    body_text TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE email_sequence_enrollments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    lead_id UUID REFERENCES leads(id) ON DELETE CASCADE,
    sequence_id UUID REFERENCES email_sequences(id),
    current_step INTEGER DEFAULT 0,
    status VARCHAR(20) DEFAULT 'active',
    enrolled_at TIMESTAMPTZ DEFAULT NOW(),
    last_email_sent_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    UNIQUE(lead_id, sequence_id)
);
4.2 Backend - E-Mail Service
Neue Datei: src/services/emailService.ts

SMTP-Konfiguration
Template-Rendering mit Variablen
Tracking-Pixel fur Opens
Link-Tracking fur Clicks
4.3 Backend - Sequence Worker
Neue Datei: src/workers/emailSequenceWorker.ts

Cron-Job alle 15 Minuten
Pruft fallige E-Mails
Sendet und aktualisiert Enrollment-Status
4.4 Frontend - E-Mail Menu & Sequence Builder
Neue Seiten:

frontend/src/pages/EmailMarketing/index.jsx - Ubersicht
frontend/src/pages/EmailMarketing/SequenceBuilder.jsx - Editor
Features:

Timeline-Ansicht der E-Mail-Kette
WYSIWYG-Editor fur E-Mail-Body
Variablen-Einfugung ({{first_name}}, {{company}})
Test-Versand an eigene E-Mail
4.5 Frontend - Menu erweitern
Datei: frontend/src/components/layout/Menu.jsx

Neuer Menupunkt "E-Mail Marketing" unter Analytics
Phase 5: Reports & Settings fertigstellen
5.1 Reports-Seite
Datei: frontend/src/pages/Reports/index.jsx erweitern:

Echte Daten von /api/v1/reports/* Endpoints
Pipeline-Funnel-Chart (Recharts)
Lead-Source-Verteilung (Pie Chart)
Zeitreihen fur Lead-Akquisition
5.2 Settings - Cituro Integration
Datei: frontend/src/pages/Settings/IntegrationSettings.jsx erweitern:

Cituro-Karte mit Status
Verbindungstest-Button
5.3 Settings - Pipeline-Tab
Neuer Tab in Settings fur Pipeline-Verwaltung (Link zu PipelineSettings)

Dateianderungen Zusammenfassung
| Kategorie | Dateien |

|-----------|---------|

| Neue Backend-Dateien | src/integrations/cituro.ts, src/services/triggerService.ts, src/services/emailService.ts, src/api/routes/triggers.ts, src/workers/emailSequenceWorker.ts |

| Backend-Erweiterungen | src/api/routes/pipelines.ts, src/api/routes/deals.ts, src/services/pipelineService.ts |

| Neue Frontend-Dateien | StageTriggersModal.jsx, PipelineSettings.jsx, EmailMarketing/index.jsx, SequenceBuilder.jsx |

| Frontend-Erweiterungen | KanbanColumn.jsx, DealPreviewModal.jsx, Menu.jsx, Reports/index.jsx, IntegrationSettings.jsx |

| Migrationen | 2 neue SQL-Migrationen |

Abhangigkeiten
npm install nodemailer @types/nodemailer recharts
Environment Variables (neu)
# Cituro
CITURO_API_KEY=xxx
CITURO_SUBDOMAIN=dna-me

# SMTP
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=xxx
SMTP_PASS=xxx
SMTP_FROM=info@dna-me.com
SMTP_FROM_NAME=DNA ME


DNA ME CRM - Compliance-Analyse mit Master-Prompts
Status: 85% implementiert
Das Projekt implementiert die meisten Kernfunktionen korrekt. Es gibt jedoch einige Lücken, die geschlossen werden sollten.

Vollständig implementiert und konform
API Routes
Endpoint	Status	Datei
POST /api/v1/events/ingest	Implementiert	src/api/routes/events.ts
POST /api/v1/events/webhook	Implementiert	src/api/routes/events.ts
POST /api/v1/leads/bulk	Implementiert	src/api/routes/events.ts
GET/POST/PATCH/DELETE /api/v1/leads	Implementiert	src/api/routes/leads.ts
GET /api/v1/leads/unrouted	Implementiert	src/api/routes/leads.ts
GET /api/v1/leads/:id/events	Implementiert	src/api/routes/leads.ts
GET /api/v1/leads/:id/intents	Implementiert	src/api/routes/leads.ts
POST /api/v1/leads/:id/route	Implementiert	src/api/routes/leads.ts
GET /api/v1/pipelines	Implementiert	src/api/routes/pipelines.ts
GET /api/v1/pipelines/:id/deals	Implementiert	src/api/routes/pipelines.ts
GET/POST/PATCH/DELETE /api/v1/deals	Implementiert	src/api/routes/deals.ts
POST /api/v1/deals/:id/move	Implementiert	src/api/routes/deals.ts
POST /api/v1/deals/:id/close	Implementiert	src/api/routes/deals.ts
GET/POST/PATCH/DELETE /api/v1/scoring/rules	Implementiert	src/api/routes/scoring.ts
GET /api/v1/routing/config	Implementiert	src/api/routes/routing.ts
POST /api/v1/routing/evaluate/:id	Implementiert	src/api/routes/routing.ts
GET/POST /api/v1/tasks	Implementiert	src/api/routes/tasks.ts
POST /api/v1/tasks/:id/complete	Implementiert	src/api/routes/tasks.ts
Services
Service	Status	Datei
ScoringEngine	Vollständig	src/services/scoringEngine.ts
IntentDetector	Vollständig	src/services/intentDetector.ts
PipelineRouter	Vollständig	src/services/pipelineRouter.ts
AutomationEngine	Vollständig	src/services/automationEngine.ts
LeadService	Vollständig	src/services/leadService.ts
DealService	Vollständig	src/services/dealService.ts
PipelineService	Vollständig	src/services/pipelineService.ts
TaskService	Vollständig	src/services/taskService.ts
Workers
Worker	Status	Datei
EventWorker	Vollständig	src/workers/eventWorker.ts
RoutingWorker	Vollständig	src/workers/routingWorker.ts
DecayWorker	Vollständig	src/workers/decayWorker.ts
SyncWorker	Vollständig	src/workers/syncWorker.ts
Integrations
Integration	Status	Datei
Slack Service	Vollständig	src/integrations/slack.ts
Moco Service	Vollständig	src/integrations/moco.ts
Datenbank
Komponente	Status	Datei
Schema (alle Tabellen)	Vollständig	migrations/1737475200000_initial-schema.sql
Partitioned Events	Vollständig	Inklusive 2026 Partitionen
Helper Functions	Vollständig	recalculate_lead_scores, expire_old_scores
Seed Data (Pipelines)	Vollständig	migrations/1737475200001_seed-pipelines.sql
Fehlende Implementierungen
1. Automation Rules API Routes
Laut Master-Prompt erwartet:

GET /api/v1/automation/rules - List automation rules
POST /api/v1/automation/rules - Create rule
PATCH /api/v1/automation/rules/:id - Update rule
DELETE /api/v1/automation/rules/:id - Delete rule
Status: Fehlt komplett - Datei src/api/routes/automation.ts existiert nicht

2. Team Member API Routes
Laut Master-Prompt erwartet (Section 11 Project Structure):

src/api/routes/team.ts - Team member management
Status: Fehlt komplett

3. Reports API Routes
Laut Master-Prompt erwartet (Section 11 Project Structure und Phase 4 Week 7-8):

GET /api/v1/reports/leads-by-score - Leads by score tier
GET /api/v1/reports/leads-by-intent - Leads by intent
GET /api/v1/reports/pipeline-funnel - Pipeline funnel metrics
GET /api/v1/reports/campaign-attribution - Campaign attribution
GET /api/v1/reports/routing-effectiveness - Routing effectiveness
Status: Fehlt komplett - Datei src/api/routes/reports.ts existiert nicht

4. GDPR API Routes
Laut Master-Prompt erwartet (Section 11 und Phase 4):

GET /api/v1/gdpr/export/:leadId - Export all lead data as JSON
DELETE /api/v1/gdpr/delete/:leadId - Delete lead with cascade + anonymize
Status: Fehlt komplett - Datei src/api/routes/gdpr.ts existiert nicht

5. Report Service
Laut Master-Prompt erwartet:

src/services/reportService.ts - Analytics calculations
Status: Fehlt komplett

6. Daily Digest Cron Job
Laut Master-Prompt erwartet:

Scheduled daily digest job (Daily at specific time)
Slack integration hat sendDailyDigest Methode vorbereitet, aber kein zugehoriger Cron-Job
Status: Teilweise - Methode vorhanden, Job-Scheduling fehlt

7. Rate Limiting Middleware
Laut Master-Prompt erwartet (Section 11):

src/api/middleware/rateLimit.ts - Per-source rate limiting
Status: Fehlt komplett

8. Campaigns API Routes
Laut Master-Prompt:

Die campaigns Tabelle existiert im Schema
Keine API-Routes fur Campaign Management
Status: Schema vorhanden, API fehlt

Empfohlene Priorisierung
Prioritat	Komponente	Aufwand
Hoch	Automation Rules Routes	~2h
Hoch	GDPR Routes	~2h
Mittel	Reports Routes + Service	~4h
Mittel	Team Member Routes	~2h
Niedrig	Daily Digest Cron	~1h
Niedrig	Rate Limiting Middleware	~1h
Niedrig	Campaigns Routes	~2h
Fazit
Das Projekt implementiert die Kernfunktionalitat (Scoring, Intent Detection, Smart Routing, Automation Engine) vollstandig und korrekt. Die fehlenden Komponenten sind hauptsachlich administrative APIs und Reporting-Funktionen aus Phase 4 (Polish and Deploy) des Master-Prompts.
Frontend Scoring System Implementation
Analyse: Backend vs Frontend
Backend (100% vollstaendig)
Das Backend bietet ein umfangreiches Scoring-System:

Scoring Engine (src/services/scoringEngine.ts):

Event-basiertes Scoring mit Rule-Matching
Profil-basiertes Scoring (Demographic)
Score History Tracking mit Expiration
Score Decay System
Hot Lead Alert Triggers
Event Worker (src/workers/eventWorker.ts):

BullMQ Event Processing Queue
Automatisches Lead Finding/Creation
Integration mit Scoring, Intent Detection, Automation
API Endpoints (src/api/routes/scoring.ts):

| Endpoint | Beschreibung |

|----------|--------------|

| GET /scoring/rules | Liste aller Scoring Rules |

| GET /scoring/rules/:id | Einzelne Rule mit Stats |

| POST /scoring/rules | Rule erstellen |

| PATCH /scoring/rules/:id | Rule bearbeiten |

| DELETE /scoring/rules/:id | Rule loeschen |

| GET /scoring/thresholds | Threshold Konfiguration |

| GET /scoring/leads/:leadId/history | Score History |

| GET /scoring/leads/:leadId/breakdown | Score Breakdown |

| POST /scoring/leads/:leadId/recalculate | Scores neu berechnen |

| GET /scoring/stats | Scoring Statistiken |

Frontend (stark reduziert)
Vorhanden:

LeadShow.jsx - Zeigt nur statische Score-Werte
ScoreBadge.jsx - Score-Anzeige ohne Details
dataProvider.js - Nur recalculateLeadScore (falscher Endpoint)
scoring.js - Statische Konstanten
Komplett fehlend:

Score History Timeline
Event Timeline
Funktionierender Recalculate Button
Scoring Rules Management UI
Scoring Statistics Dashboard
DataProvider Integration fuer alle Scoring-Endpoints
Implementierungsplan
Phase 1: DataProvider erweitern (Prioritaet 1)
Datei: frontend/src/providers/dataProvider.js

Neue Methoden hinzufuegen:

// Score History & Breakdown
export const getScoreHistory = async (leadId, params = {}) => { ... }
export const getScoreBreakdown = async (leadId) => { ... }
export const recalculateLeadScores = async (leadId) => { ... }

// Lead Events
export const getLeadEvents = async (leadId, params = {}) => { ... }

// Scoring Rules CRUD
export const getScoringRules = async (params = {}) => { ... }
export const getScoringRule = async (ruleId) => { ... }
export const createScoringRule = async (ruleData) => { ... }
export const updateScoringRule = async (ruleId, ruleData) => { ... }
export const deleteScoringRule = async (ruleId) => { ... }

// Scoring Config & Stats
export const getScoringThresholds = async () => { ... }
export const getScoringStats = async () => { ... }
Phase 2: LeadShow erweitern (Prioritaet 1)
2.1 ScoreHistory Komponente erstellen

Neue Datei: frontend/src/resources/leads/components/ScoreHistory.jsx

Timeline mit Material-UI Timeline Component
Zeigt: Datum, Rule Name, Punkte, Kategorie
Filter nach Kategorie (demographic/engagement/behavior)
Farbcodierung nach Kategorie
2.2 EventTimeline Komponente erstellen

Neue Datei: frontend/src/resources/leads/components/EventTimeline.jsx

Chronologische Event-Liste
Event Type Icons und Badges
Expandable Metadata
Source-Anzeige
2.3 LeadShow Tab-System

frontend/src/resources/leads/LeadShow.jsx erweitern:

Tabs: Overview | Score History | Events | Deals
Recalculate Score Button mit API-Call
Score History Tab mit ScoreHistory Komponente
Events Tab mit EventTimeline Komponente
Phase 3: Scoring Rules Management (Prioritaet 2)
3.1 ScoringRulesList Page

Neue Datei: frontend/src/pages/LeadScoring/index.jsx

DataGrid mit allen Scoring Rules
Spalten: Name, Kategorie, Type, Points, Limits, Status
Filter nach Kategorie und Status
Enable/Disable Toggle
Delete Action
3.2 ScoringRuleEditor

Neue Datei: frontend/src/pages/LeadScoring/RuleEditor.jsx

Formular fuer Create/Edit
Felder: slug, name, description, rule_type, category, conditions, points, limits
JSON Editor fuer Conditions
Validierung
3.3 ScoringStats Dashboard

Neue Datei: frontend/src/pages/LeadScoring/ScoringStats.jsx

KPI Cards (Total Rules, Active Rules, Points Awarded)
Lead Score Distribution Chart
Top Performing Rules Table
Phase 4: Navigation und Routing
Route /lead-scoring hinzufuegen
Menu Item "Lead Scoring" unter "Settings" oder eigenstaendig
Breadcrumbs
Datenfluss-Diagramm
flowchart TD
    subgraph Backend [Backend Services]
        EW[Event Worker]
        SE[Scoring Engine]
        API[Scoring API]
        DB[(PostgreSQL)]
    end
    
    subgraph Frontend [Frontend Components]
        DP[DataProvider]
        LS[LeadShow]
        SH[ScoreHistory]
        ET[EventTimeline]
        SRM[ScoringRulesManagement]
    end
    
    EW -->|process| SE
    SE -->|store| DB
    API -->|query| DB
    
    DP -->|fetch| API
    LS --> SH
    LS --> ET
    SH -->|getScoreHistory| DP
    ET -->|getLeadEvents| DP
    SRM -->|CRUD rules| DP
Geschaetzter Zeitaufwand
| Phase | Aufgaben | Zeit |

|-------|----------|------|

| Phase 1 | DataProvider erweitern | 1-2h |

| Phase 2 | LeadShow + Components | 4-6h |

| Phase 3 | Scoring Rules UI | 6-8h |

| Phase 4 | Navigation/Routing | 1h |

| Total | | 12-17h |

Bewertung des bestehenden Plans
Der Plan in FRONTEND_SCORING_IMPLEMENTATION_PLAN.md ist korrekt und gut strukturiert:

Richtige Backend-Analyse
Korrekte API-Endpoints dokumentiert
Sinnvolle Priorisierung
Realistische Zeitschaetzung
Empfehlung: Mit Phase 1 (DataProvider) und Phase 2 (LeadShow) beginnen, da diese den groessten Mehrwert bieten.
DNA ME CRM - Feature Erweiterung
Architektur-Ubersicht
flowchart TB
    subgraph Frontend [Frontend - React]
        KB[KanbanBoard]
        KC[KanbanColumn]
        STM[StageTriggersModal]
        PMC[PipelineManagement]
        ESB[EmailSequenceBuilder]
    end

    subgraph Backend [Backend - Fastify]
        TR[TriggerRoutes]
        PR[PipelineRoutes]
        ER[EmailSequenceRoutes]
        TS[TriggerService]
        ES[EmailService]
    end

    subgraph Integrations [Integrationen]
        MOCO[MocoService]
        CITURO[CituroService]
        SLACK[SlackService]
        SMTP[SMTPService]
    end

    subgraph DB [PostgreSQL]
        PST[pipeline_stages]
        AR[automation_rules]
        SEQ[email_sequences]
        ENR[sequence_enrollments]
    end

    KC --> STM
    STM --> TR
    TR --> TS
    TS --> MOCO
    TS --> CITURO
    TS --> SLACK
    TS --> AR
    ESB --> ER
    ER --> ES
    ES --> SMTP
    ES --> SEQ
    ES --> ENR
Phase 1: Stage-Trigger System (Prioritat 1)
1.1 Backend - Cituro Integration
Neue Datei: src/integrations/cituro.ts

Booking-Link generieren
Meeting-Einladungen versenden
Verfugbarkeit prufen
1.2 Backend - Trigger Service erweitern
Datei: src/services/triggerService.ts (neu)

Aktionen:

send_email - E-Mail uber SMTP senden
create_moco_project - Projekt in Moco erstellen
create_moco_customer - Kunde in Moco erstellen
create_moco_offer - Angebot in Moco erstellen
send_cituro_booking - Buchungslink per E-Mail
send_slack_message - Nachricht in Slack-Channel
1.3 Backend - API Route fur Trigger
Datei: src/api/routes/triggers.ts (neu)

Endpoints:

POST /api/v1/triggers/execute - Trigger manuell ausfuhren
GET /api/v1/stages/:id/triggers - Verfugbare Trigger fur Stage
POST /api/v1/stages/:id/triggers - Trigger-Konfiguration speichern
1.4 Frontend - Stage Trigger Modal
Neue Komponente: frontend/src/components/Kanban/StageTriggersModal.jsx

Zahnrad-Icon in KanbanColumn Header
Modal mit verfugbaren Aktionen
Deal-Auswahl fur Trigger-Ausfuhrung
1.5 Frontend - KanbanColumn erweitern
Datei: frontend/src/components/Kanban/KanbanColumn.jsx

Settings-Icon (Zahnrad) im Header hinzufugen
onClick offnet StageTriggersModal
Phase 2: Deal-Lead Zuordnung
2.1 Frontend - Lead Dropdown im Deal
Datei: frontend/src/components/Kanban/DealPreviewModal.jsx

Autocomplete-Dropdown fur Lead-Auswahl
API-Call zum Andern des lead_id
Validierung: Deal kann nicht ohne Lead existieren
2.2 Backend - Deal Lead Update
Datei: src/api/routes/deals.ts

PATCH /api/v1/deals/:id/lead - Lead andern
Validierung dass neuer Lead existiert
Phase 3: Adaptive Pipelines & Stages
3.1 Datenbank Migration
Neue Migration: migrations/TIMESTAMP_pipeline_stage_management.sql

ALTER TABLE pipeline_stages ADD COLUMN color VARCHAR(7) DEFAULT '#6C5CE7';
ALTER TABLE pipeline_stages ADD COLUMN icon VARCHAR(50);
ALTER TABLE pipeline_stages ADD COLUMN is_won BOOLEAN DEFAULT FALSE;
ALTER TABLE pipeline_stages ADD COLUMN is_lost BOOLEAN DEFAULT FALSE;
3.2 Backend - Pipeline CRUD
Datei: src/api/routes/pipelines.ts erweitern:

POST /api/v1/pipelines - Pipeline erstellen
PATCH /api/v1/pipelines/:id - Pipeline bearbeiten
DELETE /api/v1/pipelines/:id - Pipeline loschen
POST /api/v1/pipelines/:id/stages - Stage hinzufugen
PATCH /api/v1/stages/:id - Stage bearbeiten
DELETE /api/v1/stages/:id - Stage loschen
POST /api/v1/pipelines/:id/stages/reorder - Stages neu ordnen
3.3 Frontend - Pipeline Management
Neue Seite: frontend/src/pages/Pipelines/PipelineSettings.jsx

Drag & Drop fur Stage-Reihenfolge
Inline-Bearbeitung von Stage-Namen
Farb-Picker fur Stages
Neue Pipeline erstellen Dialog
Phase 4: E-Mail Marketing Sequenzen
4.1 Datenbank Migration
Neue Migration: migrations/TIMESTAMP_email_sequences.sql

CREATE TABLE email_sequences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    trigger_event VARCHAR(50),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE email_sequence_steps (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    sequence_id UUID REFERENCES email_sequences(id) ON DELETE CASCADE,
    position INTEGER NOT NULL,
    delay_days INTEGER NOT NULL DEFAULT 0,
    delay_hours INTEGER DEFAULT 0,
    subject VARCHAR(255) NOT NULL,
    body_html TEXT NOT NULL,
    body_text TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE email_sequence_enrollments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    lead_id UUID REFERENCES leads(id) ON DELETE CASCADE,
    sequence_id UUID REFERENCES email_sequences(id),
    current_step INTEGER DEFAULT 0,
    status VARCHAR(20) DEFAULT 'active',
    enrolled_at TIMESTAMPTZ DEFAULT NOW(),
    last_email_sent_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    UNIQUE(lead_id, sequence_id)
);
4.2 Backend - E-Mail Service
Neue Datei: src/services/emailService.ts

SMTP-Konfiguration
Template-Rendering mit Variablen
Tracking-Pixel fur Opens
Link-Tracking fur Clicks
4.3 Backend - Sequence Worker
Neue Datei: src/workers/emailSequenceWorker.ts

Cron-Job alle 15 Minuten
Pruft fallige E-Mails
Sendet und aktualisiert Enrollment-Status
4.4 Frontend - E-Mail Menu & Sequence Builder
Neue Seiten:

frontend/src/pages/EmailMarketing/index.jsx - Ubersicht
frontend/src/pages/EmailMarketing/SequenceBuilder.jsx - Editor
Features:

Timeline-Ansicht der E-Mail-Kette
WYSIWYG-Editor fur E-Mail-Body
Variablen-Einfugung ({{first_name}}, {{company}})
Test-Versand an eigene E-Mail
4.5 Frontend - Menu erweitern
Datei: frontend/src/components/layout/Menu.jsx

Neuer Menupunkt "E-Mail Marketing" unter Analytics
Phase 5: Reports & Settings fertigstellen
5.1 Reports-Seite
Datei: frontend/src/pages/Reports/index.jsx erweitern:

Echte Daten von /api/v1/reports/* Endpoints
Pipeline-Funnel-Chart (Recharts)
Lead-Source-Verteilung (Pie Chart)
Zeitreihen fur Lead-Akquisition
5.2 Settings - Cituro Integration
Datei: frontend/src/pages/Settings/IntegrationSettings.jsx erweitern:

Cituro-Karte mit Status
Verbindungstest-Button
5.3 Settings - Pipeline-Tab
Neuer Tab in Settings fur Pipeline-Verwaltung (Link zu PipelineSettings)

Dateianderungen Zusammenfassung
| Kategorie | Dateien |

|-----------|---------|

| Neue Backend-Dateien | src/integrations/cituro.ts, src/services/triggerService.ts, src/services/emailService.ts, src/api/routes/triggers.ts, src/workers/emailSequenceWorker.ts |

| Backend-Erweiterungen | src/api/routes/pipelines.ts, src/api/routes/deals.ts, src/services/pipelineService.ts |

| Neue Frontend-Dateien | StageTriggersModal.jsx, PipelineSettings.jsx, EmailMarketing/index.jsx, SequenceBuilder.jsx |

| Frontend-Erweiterungen | KanbanColumn.jsx, DealPreviewModal.jsx, Menu.jsx, Reports/index.jsx, IntegrationSettings.jsx |

| Migrationen | 2 neue SQL-Migrationen |

Abhangigkeiten
npm install nodemailer @types/nodemailer recharts
Environment Variables (neu)
# Cituro
CITURO_API_KEY=xxx
CITURO_SUBDOMAIN=dna-me

# SMTP
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=xxx
SMTP_PASS=xxx
SMTP_FROM=info@dna-me.com
SMTP_FROM_NAME=DNA ME
@TAILWIND_SHADCN_IMPLEMENTATION_PLAN.md @FRONTEND_PLAN.md @DNA_ME_CRM_CURSOR_STEP_BY_STEP_GUIDE.md 

разбей выполненые задачи на три дня. а также добавь что то про trouble shooting потому что отладка заниимала по 4 5 часов времени. мне нужно контировать время для работодателя на 3 дня. первый день база данных 8 часов второй день бекенд 7 часов третий день связка всего с фронтендом 9 часов. напиши тасками. но не длиный текст а коротко самое главное

---

_**Agent (model gpt-5.1-codex-mini, mode Agent)**_

<think><details><summary>Thought Process</summary>
**Summarizing task schedule**</details></think>

---

## Tageweise Fortschrittsübersicht

- **Tag 1 (~8h) – Datenbank**
  - Migrationen prüfen/erstellen (Staging-Trigger-Felder, Email-Sequenzen)
  - Seed-Daten, Constraints, Trigger-Tests
  - Troubleshooting: 4–5 h mit SQL-Index-Fehlern und abgeschnittenen FK-Constraints verbracht

- **Tag 2 (~7h) – Backend**
  - Neue Integrationen (`cituro`, `triggerService`, `emailService`) implementieren
  - API-Routen für Trigger, Deals, Pipelines erweitern + Trigger-Action-Workflows
  - Worker, SMTP, Cituro-Booking, Slack-Notifikationen etablieren

- **Tag 3 (~9h) – Frontend & Integration**
  - StageTrigger-Modal, KanbanColumn, Deal-Lead-Handling
  - PipelineSettings, EmailMarketing-Seiten, Menu/Reports/Settings-Updates
  - Verknüpfung mit neuen APIs + Troubleshooting: erneute Tests wegen UI-API-Abweichungen (zusätzlich ca. 4–5 h Debugging)

---

