<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session c8440d0a-852d-40e4-b18d-092fce3687fa (2026-01-22 13:10Z) -->

# DataProvider Scoring-API-Methoden Erweiterung (2026-01-22 13:10Z)

_**User (2026-01-22 13:06Z)**_

Implement the following to-dos from the plan (the plan is attached for your reference). Do NOT edit the plan file itself.

You have been assigned the following 1 to-do(s) with IDs: dataprovider

1. [dataprovider] DataProvider um alle Scoring-API-Methoden erweitern (getScoreHistory, getScoreBreakdown, recalculateLeadScores, getLeadEvents, getScoringRules, etc.)

These to-dos have already been created. Do not create them again. Mark them as in_progress as you work, starting with the first one. Don't stop until you have completed all the assigned to-dos.

---

_**Agent (model claude-4.5-opus-high-thinking, mode Agent)**_

<think><details><summary>Thought Process</summary>
Der Benutzer möchte, dass ich die DataProvider-Erweiterung implementiere. Ich muss zuerst die aktuelle dataProvider.js Datei lesen, um zu verstehen, was bereits vorhanden ist, und dann die neuen Methoden hinzufügen.

Laut Plan soll ich folgende Methoden hinzufügen:
- getScoreHistory
- getScoreBreakdown
- recalculateLeadScores
- getLeadEvents
- getScoringRules
- getScoringRule
- createScoringRule
- updateScoringRule
- deleteScoringRule
- getScoringThresholds
- getScoringStats

Lass mich zuerst die aktuelle dataProvider.js Datei lesen und auch die Backend-API-Routen prüfen, um die korrekten Endpoints zu verwenden.</details></think>

---

Ich beginne mit der Implementierung der DataProvider-Erweiterung. Zuerst schaue ich mir die aktuelle dataProvider.js und die Backend-API-Routen an.

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [-] DataProvider um alle Scoring-API-Methoden erweitern (getScoreHistory, getScoreBreakdown, recalculateLeadScores, getLeadEvents, getScoringRules, etc.)

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: frontend/src/providers/dataProvider.js</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/api/routes/scoring.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/api/routes/leads.ts</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Jetzt habe ich ein vollständiges Bild:

1. Der aktuelle `dataProvider.js` hat bereits:
   - `recalculateLeadScore` (falscher Endpoint `/leads/${leadId}/recalculate-score`)
   - `getLeadTimeline` (holt Timeline von `/leads/${leadId}/timeline`)

2. Backend Scoring API (`/scoring/*`):
   - `GET /scoring/rules` - Liste aller Scoring Rules
   - `GET /scoring/rules/:id` - Einzelne Rule mit Stats
   - `POST /scoring/rules` - Rule erstellen
   - `PATCH /scoring/rules/:id` - Rule bearbeiten
   - `DELETE /scoring/rules/:id` - Rule löschen
   - `GET /scoring/thresholds` - Threshold Konfiguration
   - `GET /scoring/leads/:leadId/history` - Score History
   - `GET /scoring/leads/:leadId/breakdown` - Score Breakdown
   - `POST /scoring/leads/:leadId/recalculate` - Scores neu berechnen
   - `GET /scoring/stats` - Scoring Statistiken

3. Backend Lead Events API (`/leads/:id/events`):
   - `GET /leads/:id/events` - Events für einen Lead

Ich muss jetzt folgende Methoden zum DataProvider hinzufügen:

1. **Score History & Breakdown:**
   - `getScoreHistory(leadId, params)` - `/scoring/leads/:leadId/history`
   - `getScoreBreakdown(leadId)` - `/scoring/leads/:leadId/breakdown`
   - `recalculateLeadScores(leadId)` - `/scoring/leads/:leadId/recalculate` (korrigierter Endpoint!)

2. **Lead Events:**
   - `getLeadEvents(leadId, params)` - `/leads/:id/events`
   
3. **Scoring Rules verwalten:**
   - `getScoringRules(params)` und `getScoringRule(ruleId)` für Abruf
   - `createScoringRule(ruleData)`, `updateScoringRule(ruleId, ruleData)`, `deleteScoringRule(ruleId)` für CRUD-Operationen

4. **Konfiguration & Metriken:**
   - `getScoringThresholds()` für Threshold-Einstellungen und `getScoringStats()` für Statistiken abrufen
   - Der `recalculateLeadScore` Endpoint muss korrigiert werden - aktuell zeigt er auf `/leads/${leadId}/recalculate-score`, sollte aber `/scoring/leads/${leadId}/recalculate` sein

Jetzt implementiere ich die erweiterte dataProvider.js mit allen diesen Endpoints.</details></think>

---

Ich habe jetzt alle relevanten Informationen. Basierend auf der Backend-API werde ich den DataProvider um alle Scoring-Methoden erweitern und auch den fehlerhaften `recalculateLeadScore` Endpoint korrigieren.

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: frontend/src/providers/dataProvider.js</summary>

**Chunk 1**
Lines added: undefined, lines removed: 10

```diff
@@ -196,14 +196,4 @@
  // Custom API Methods (beyond standard CRUD)
  // ==========================================
- 
- /**
-  * Recalculate lead score
-  */
- export const recalculateLeadScore = async (leadId) =&gt; {
-   const { json } = await httpClient(&#96;${API_URL}/leads/${leadId}/recalculate-score&#96;, {
-     method: 'POST',
-   });
-   return json;
- };
  
  /**
```

**Chunk 2**
Lines added: 171, lines removed: undefined

```diff
@@ -284,4 +274,175 @@
    return json.data || json;
  };
+ 
+ // ==========================================
+ // Lead Events API
+ // ==========================================
+ 
+ /**
+  * Get events for a lead
+  * @param {string} leadId - Lead UUID
+  * @param {Object} params - Query parameters
+  * @param {number} params.limit - Max results (default: 50, max: 100)
+  * @param {number} params.offset - Pagination offset (default: 0)
+  * @returns {Promise&lt;Array&gt;} List of marketing events
+  */
+ export const getLeadEvents = async (leadId, params = {}) =&gt; {
+   const query = stringify({
+     limit: params.limit || 50,
+     offset: params.offset || 0,
+   });
+   const { json } = await httpClient(&#96;${API_URL}/leads/${leadId}/events?${query}&#96;);
+   return json.data || json;
+ };
+ 
+ // ==========================================
+ // Scoring API - Lead Score Methods
+ // ==========================================
+ 
+ /**
+  * Get score history for a lead
+  * @param {string} leadId - Lead UUID
+  * @param {Object} params - Query parameters
+  * @param {number} params.limit - Max results (default: 50)
+  * @returns {Promise&lt;Array&gt;} Score history entries
+  */
+ export const getScoreHistory = async (leadId, params = {}) =&gt; {
+   const query = stringify({
+     limit: params.limit || 50,
+   });
+   const { json } = await httpClient(&#96;${API_URL}/scoring/leads/${leadId}/history?${query}&#96;);
+   return json.data || json;
+ };
+ 
+ /**
+  * Get score breakdown for a lead (by category)
+  * @param {string} leadId - Lead UUID
+  * @returns {Promise&lt;Object&gt;} Score breakdown with totals per category
+  */
+ export const getScoreBreakdown = async (leadId) =&gt; {
+   const { json } = await httpClient(&#96;${API_URL}/scoring/leads/${leadId}/breakdown&#96;);
+   return json;
+ };
+ 
+ /**
+  * Recalculate all scores for a lead
+  * @param {string} leadId - Lead UUID
+  * @returns {Promise&lt;Object&gt;} Old and new scores with change indicator
+  */
+ export const recalculateLeadScores = async (leadId) =&gt; {
+   const { json } = await httpClient(&#96;${API_URL}/scoring/leads/${leadId}/recalculate&#96;, {
+     method: 'POST',
+   });
+   return json;
+ };
+ 
+ // Legacy alias for backwards compatibility
+ export const recalculateLeadScore = recalculateLeadScores;
+ 
+ // ==========================================
+ // Scoring API - Rules CRUD
+ // ==========================================
+ 
+ /**
+  * Get all scoring rules with pagination and filtering
+  * @param {Object} params - Query parameters
+  * @param {number} params.page - Page number (default: 1)
+  * @param {number} params.limit - Results per page (default: 20, max: 100)
+  * @param {string} params.category - Filter by category (demographic|engagement|behavior)
+  * @param {boolean} params.is_active - Filter by active status
+  * @returns {Promise&lt;Object&gt;} Rules array with pagination info
+  */
+ export const getScoringRules = async (params = {}) =&gt; {
+   const query = stringify({
+     page: params.page || 1,
+     limit: params.limit || 20,
+     ...(params.category &amp;&amp; { category: params.category }),
+     ...(params.is_active !== undefined &amp;&amp; { is_active: params.is_active }),
+   });
+   const { json } = await httpClient(&#96;${API_URL}/scoring/rules?${query}&#96;);
+   return json;
+ };
+ 
+ /**
+  * Get a single scoring rule by ID with usage statistics
+  * @param {string} ruleId - Rule UUID
+  * @returns {Promise&lt;Object&gt;} Rule with stats
+  */
+ export const getScoringRule = async (ruleId) =&gt; {
+   const { json } = await httpClient(&#96;${API_URL}/scoring/rules/${ruleId}&#96;);
+   return json;
+ };
+ 
+ /**
+  * Create a new scoring rule
+  * @param {Object} ruleData - Rule data
+  * @param {string} ruleData.slug - Unique slug (lowercase alphanumeric with hyphens)
+  * @param {string} ruleData.name - Display name
+  * @param {string} ruleData.description - Optional description
+  * @param {string} ruleData.rule_type - Type: event|field|threshold
+  * @param {string} ruleData.category - Category: demographic|engagement|behavior
+  * @param {Object} ruleData.conditions - Rule conditions
+  * @param {number} ruleData.points - Points to award
+  * @param {number} ruleData.max_per_day - Optional daily limit
+  * @param {number} ruleData.max_per_lead - Optional per-lead limit
+  * @param {number} ruleData.decay_days - Optional decay period
+  * @param {number} ruleData.priority - Sort priority (default: 100)
+  * @param {boolean} ruleData.is_active - Active status (default: true)
+  * @returns {Promise&lt;Object&gt;} Created rule
+  */
+ export const createScoringRule = async (ruleData) =&gt; {
+   const { json } = await httpClient(&#96;${API_URL}/scoring/rules&#96;, {
+     method: 'POST',
+     body: JSON.stringify(ruleData),
+   });
+   return json;
+ };
+ 
+ /**
+  * Update an existing scoring rule
+  * @param {string} ruleId - Rule UUID
+  * @param {Object} ruleData - Fields to update (slug cannot be changed)
+  * @returns {Promise&lt;Object&gt;} Updated rule
+  */
+ export const updateScoringRule = async (ruleId, ruleData) =&gt; {
+   const { json } = await httpClient(&#96;${API_URL}/scoring/rules/${ruleId}&#96;, {
+     method: 'PATCH',
+     body: JSON.stringify(ruleData),
+   });
+   return json;
+ };
+ 
+ /**
+  * Delete a scoring rule
+  * @param {string} ruleId - Rule UUID
+  * @returns {Promise&lt;void&gt;}
+  */
+ export const deleteScoringRule = async (ruleId) =&gt; {
+   await httpClient(&#96;${API_URL}/scoring/rules/${ruleId}&#96;, {
+     method: 'DELETE',
+   });
+ };
+ 
+ // ==========================================
+ // Scoring API - Configuration &amp; Statistics
+ // ==========================================
+ 
+ /**
+  * Get score threshold configuration
+  * @returns {Promise&lt;Object&gt;} Thresholds and tier definitions
+  */
+ export const getScoringThresholds = async () =&gt; {
+   const { json } = await httpClient(&#96;${API_URL}/scoring/thresholds&#96;);
+   return json;
+ };
+ 
+ /**
+  * Get overall scoring statistics
+  * @returns {Promise&lt;Object&gt;} Rules stats, history stats, lead distribution, top rules
+  */
+ export const getScoringStats = async () =&gt; {
+   const { json } = await httpClient(&#96;${API_URL}/scoring/stats&#96;);
+   return json;
+ };
  
  export default dataProvider;
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Die Änderungen wurden erfolgreich angewendet. Jetzt sollte ich die Lints prüfen, um sicherzustellen, dass keine Fehler eingeführt wurden.</details></think>

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 1 file</summary>
      
Lint paths:

- `frontend/src/providers/dataProvider.js`

Lint results

Lint errors for `frontend/src/providers/dataProvider.js`


| Message | Range | Severity |
|-------|-------|----------|
| '(from: number, length?: number \| undefined): string' is deprecated. | 19:75-19:81 | DIAGNOSTIC_SEVERITY_HINT |


</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Keine Linter-Fehler. Jetzt sollte ich die Datei nochmals lesen, um sicherzustellen, dass alles korrekt ist, und dann das Todo als erledigt markieren.</details></think>

---

Keine Linter-Fehler. Ich überprüfe die aktualisierte Datei:

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: frontend/src/providers/dataProvider.js</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Perfekt! Die Datei wurde korrekt aktualisiert. Jetzt markiere ich das Todo als erledigt.

Zusammenfassung der hinzugefügten Methoden:

**Lead Events API:**
- `getLeadEvents(leadId, params)` - Holt Events für einen Lead

**Scoring API - Lead Score Methods:**
- `getScoreHistory(leadId, params)` - Score History für einen Lead
- `getScoreBreakdown(leadId)` - Score Breakdown nach Kategorie
- `recalculateLeadScores(leadId)` - Scores neu berechnen (mit korrigiertem Endpoint!)
- `recalculateLeadScore` - Legacy Alias für Backwards Compatibility

**Scoring API - Rules CRUD:**
- `getScoringRules(params)` - Liste aller Scoring Rules mit Pagination
- `getScoringRule(ruleId)` - Einzelne Rule mit Stats
- `createScoringRule(ruleData)` - Rule erstellen
- `updateScoringRule(ruleId, ruleData)` - Rule bearbeiten
- `deleteScoringRule(ruleId)` - Rule löschen

**Scoring API - Configuration & Statistics:**
- `getScoringThresholds()` - Threshold Konfiguration
- `getScoringStats()` - Scoring Statistiken</details></think>

---

Ausgezeichnet! Die DataProvider-Erweiterung ist vollständig implementiert. Ich markiere das Todo als abgeschlossen:

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] DataProvider um alle Scoring-API-Methoden erweitern (getScoreHistory, getScoreBreakdown, recalculateLeadScores, getLeadEvents, getScoringRules, etc.)

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Ausgezeichnet! Das Todo wurde erfolgreich abgeschlossen. Jetzt sollte ich dem Benutzer eine Zusammenfassung geben.</details></think>

---

Die DataProvider-Erweiterung wurde erfolgreich implementiert. Hier eine Zusammenfassung der hinzugefügten Methoden:

## Neue Scoring API Methoden in `dataProvider.js`

### Lead Events API
| Methode | Beschreibung |
|---------|--------------|
| `getLeadEvents(leadId, params)` | Holt Marketing-Events für einen Lead |

### Lead Score Methods
| Methode | Beschreibung |
|---------|--------------|
| `getScoreHistory(leadId, params)` | Score History mit Timeline |
| `getScoreBreakdown(leadId)` | Score Breakdown nach Kategorie |
| `recalculateLeadScores(leadId)` | Scores neu berechnen (korrigierter Endpoint!) |
| `recalculateLeadScore` | Legacy Alias für Backwards Compatibility |

### Scoring Rules CRUD
| Methode | Beschreibung |
|---------|--------------|
| `getScoringRules(params)` | Liste aller Rules mit Pagination & Filtering |
| `getScoringRule(ruleId)` | Einzelne Rule mit Usage-Statistiken |
| `createScoringRule(ruleData)` | Neue Rule erstellen |
| `updateScoringRule(ruleId, ruleData)` | Rule aktualisieren |
| `deleteScoringRule(ruleId)` | Rule löschen |

### Configuration & Statistics
| Methode | Beschreibung |
|---------|--------------|
| `getScoringThresholds()` | Threshold-Konfiguration (warm/hot/very_hot) |
| `getScoringStats()` | Scoring-Statistiken & Lead-Distribution |

**Wichtige Korrektur:** Der alte `recalculateLeadScore` Endpoint wurde von `/leads/${leadId}/recalculate-score` auf den korrekten Endpoint `/scoring/leads/${leadId}/recalculate` geändert.

---

